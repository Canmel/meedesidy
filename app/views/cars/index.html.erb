<% provide(:title, '车辆信息') %>
<div class="panel col-md-12 col-lg-12 col-sm-12 col-xs-12">
  <h5 class="page-header">查询条件</h5>
  <div class="dataTables_wrapper form-inline">
    <div>
    <%= search_form_for @q, :html => {:class => 'pjax-form'} do |f| %>
        <%= f.label "车牌号：", class: "control-label" %>
        <%= f.search_field :car_no_cont, class: 'form-control' %>
        <%= f.label "车架号：", class: "control-label" %>
        <%= f.search_field :vin_cont, class: 'form-control' %>
        <%= link_to '新增', :new_car, class: "btn meedesidy_btn_new" %>
        <button type="submit" class="btn meedesidy_btn_query" data-toggle="modal" data-target="#search_model">查询</button>
    <% end %>
    </div>
  </div>
  <h3 class="sub-header">车辆列表
    <div class="notice text-center">
    <% if flash[:car_notice] %>
        <span class="label meedesidy_notice_info"><%= flash[:car_notice] %></span>
    <% end %>
    </div>
  </h3>
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="editable-sample">
      <thead>
      <tr>
        <th>#</th>
        <th>车牌号</th>
        <th>车架号</th>
        <th>车型</th>
        <th>颜色</th>
        <th>服务公司</th>
        <th>操作</th>
      </tr>
      </thead>
      <tbody>
      <% @cars.each_with_index do |car, index| %>
        <tr>
          <td><%= sequence index %></td>
          <td><%= car.car_no %></td>
          <td><%= car.vin %></td>
          <td><%= car.geren&.name %></td>
          <td><%= car.color %></td>
          <td><%= car.company.present? ? car.company&.sort_name : "未发车" %></td>
          <td>
            <%= link_to '编辑', edit_car_path(car), class: 'label meedesidy_btn_edit'%>
            <%= link_to '删除', car, data: {confirm: "确认要删除#{car.car_no}?"}, method: :delete, class: "label meedesidy_btn_delete" %>
            <a class="label meedesidy_btn_1" modal_car_no="<%= car.car_no %>" modal_car_geren="<%= car.geren&.name %>" data-toggle="modal" href="##" data-target="#myModal" name="grant" data="<%= car.id %>">发车</a>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
    共<%= @cars.total_count %>条 <%= @cars.total_pages %>页 <%= paginate @cars %>
  </div>
</div>
<!--发车模态-->
<%= model_render %>
<script>
  $(function () {
    $("a[name='grant']").click(function () {
      var data = $(this).attr("data");
      var modal_car_no = $(this).attr("modal_car_no");
      var modal_car_geren = $(this).attr("modal_car_geren");
      $("#myModalLabel").text(modal_car_no+ " | " + modal_car_geren);
      $("#p_company").text(modal_car_no);
      $("#p_geren").text(modal_car_geren);
      $("input[name='id']").val(data);
    });
    
    $("#grant_confirm").click(function () {
      $.ajax({
        url: '/cars/'+  $("input[name='id']").val() +'/grant',
        data: { company_id: $("#car_company_id").val() },
        method: 'POST',
        success: function(data){
          if(data["result"] != null){
            showResult(data["result"]);
          }


          setTimeout(function () {
            $("#car_search").submit()
          }, 500);
        }
      })

    })

  })
  function showResult(result) {
    $("#myModal").modal('hide');
    $(".notice").html("<div class='notice text-center'><span class='label meedesidy_notice_info'>"+ result +"</span></div>")
  }
</script>